<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Super Insurance</title>
</head>
<body>
<%- include('partials/navbar.ejs') %>
<H1><%= message %></H1>
<form id="modification-profile">
  <label for="username">User Name :</label>
  <input type="text" id="username" name="username" required readonly>
  <label for="password">Password&nbsp;:</label>
  <input type="password" id="password" name="password" required>
  <label for="email">E-mail&nbsp;:</label>
  <input type="email" id="email" name="email" required>
  <label for="address">Address :</label>
  <input type="text" id="address" name="address" required>
  <label for="phoneNumber">Phone Number :</label>
  <input type="tel" id="phoneNumber" name="phoneNumber" required>
  <input type="submit" value="Modification confirmed" id="modification-profile-submit">
</form>

<script>
  const response = fetch("/profile", {
    method: 'GET',
    headers: { "Authorization": "Bearer " + sessionStorage.getItem("team_galaxy_access_token") }
  }).then(response => {
    if(!response.ok){
      location.href = "/";
    }
    return response.json();
  }).then(data => {
    const getCustomer = fetch("/customer/id/" + String(data.id), {
      method: 'GET',
      headers: { "Authorization": "Bearer " + sessionStorage.getItem("team_galaxy_access_token") }
    }).then(response => {
      return response.json();
    }).then(getPassword => {
      document.getElementById("username").value = data.username;
      document.getElementById("password").value = getPassword.password;
      document.getElementById("email").value = data.email;
      document.getElementById("address").value = data.address;
      document.getElementById("phoneNumber").value = data.phoneNumber;
    });
  }).catch(err => {
  });
</script>

<script>
  const response2 = fetch("/profile", {
    method: 'GET',
    headers: { "Authorization": "Bearer " + sessionStorage.getItem("team_galaxy_access_token") }
  }).then(response2 => {
    if(!response2.ok){
      location.href = "/";
    }
    return response2.json();
  }).then(data => {
    const modificationProfileButton = document.getElementById("modification-profile-submit");
    modificationProfileButton.addEventListener("click", async (e) => {
      e.preventDefault();

      const response = await fetch("/customer/update", {
        method: 'POST',
        body: JSON.stringify({
          "id": data.id,
          "username": String(document.getElementById("username").value),
          "password": String(document.getElementById("password").value),
          "address" : String(document.getElementById("address").value),
          "phoneNumber" : String(document.getElementById("phoneNumber").value),
          "email" : String(document.getElementById("email").value)
        }),
        headers: { "Content-Type": "application/json" }
      });
      if (response.ok) {
        alert("Your information has been modified, please reconnect");
        sessionStorage.removeItem("team_galaxy_access_token");
        location.href = "/auth/login";
      }else{
        console.log(response.status)
        alert("Some fields are missing or isn't in the right format, please retry");
      }
    });
  }).catch(err => {
  });
</script>

</body>
</html>